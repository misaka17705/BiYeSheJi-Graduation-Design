
一. 绪论
	1.1 研究背景
		1.1.1 问题的提出
			卫星遥感图像的配准一直是遥感图像图像处理的一个重点领域。尤其是高光谱遥感卫星，由于波段众多，光谱响应也不尽相同，要获得一个区域准确而全面的信息时，图像配准的重要性非常明显。图像配准良好的情况下才能合成优质的光谱图像，否则当配准不佳的时候，合成的图像会出现模糊，重影的现象。
			在多光谱成像的仪器中，多个不同的波段会占用同一个光学仪器的入瞳，但由于不同波段的探测器在光学系统中的焦平面各不相同，这些不同焦平面所对应的探测视场范围也各不相同。这些波段视场的区别导致了同一时刻不同波段注视的地面目标不同，这会造成不同波段的图像之间产生误差。而这些误差是在设计光学仪器的时候就不可避免的。大多探测器会在地面设计阶段就定量测量各波段之间的误差，从而在地面校正的时候就输入参数，将卫星发送回的图像进行切割。
			对图像配准，尤其是在波段众多的情况下配准，对于我们获得地物和大气的完整信息具有重要意义。地面校正的作用是直接切割遥感图像，使其在像素级误差上逐像素对齐。但不同波段的焦平面位置不同和安装的误差等因素，造成了不同的探测器之间除了地面设计阶段校正的像素级误差外，还可能有着亚像元级别的误差，这些误差也需要被校正。而这些误差不能简单的通过将卫星图像进行配准，而是需要将图像先进行重采样的工作之后再进行配准。
			随着图像合成的要求越来越高，而传统的像元级配准无法应对不同波段图像之间的微小误差这种情况，像元级别的配准只能让图像重合在一个相对准确的水平，但不能消除亚像元误差造成的拖影现象，为了消除拖影，需要开发一种对于卫星遥感图像的亚像元配准算法。
		1.1.2 研究内容梗概
			1.了解MERSI在轨扫描机制，掌握载荷观测方式和成像原理。
			2.选择合适的地球目标，提取月球观测资料，根据MERSI焦平面分布进行图像相关分析，建立亚像元级配准参数计算模型，计算亚像元级配准参数，对MERSI业务配准精度和稳定性进行评价。
			3.建立亚像元级重采样算法，根据配准参数进行图像重采样。
			4.通过独立方案对重采样后的通道配准精度，以及亚像元配准对图像合成质量提升效果
		1.1.3 研究意义
			1.1.3.1 对算法的效果评价
			通过使用不同于以往的亚像元配准评价标准编写的新算法，可以通过验证与其他已有算法的一致性等方法来判断这个算法本身的素质，通过验证不同的图像验证算法的稳定性和适用范围。
			1.1.3.2 对卫星图像的配准效果评价
			开发了针对卫星遥感图像配准的算法之后，首要的作用就是可以对遥感图像进行亚像元配准的效果评价，可以对比之前其他作者对相应遥感图像进行亚像元配准的结果来接近亚像元误差的真实值。

	1.2 研究现状
		1.2.1 卫星载荷现状
			1.2.1.1 风云卫星系列介绍
			在地球的上空，大气覆盖着地球的表面。卫星在太空中对地面进行观测，就需要透过不同层级的大气，以观测不同高度的目标。而大气里的各种分子对不同的波长光吸收强度不同，造成了大气有着一个个“大气窗口”，可以使特定波段的光较容易到达地面，而卫星就使用这些波段进行对地观测，而有的穿透力较弱的波段则较为适合进行对空观测，用来识别云层等目标。而通过在卫星上添加一系列的光谱探测器，就可以使得卫星获得从高到低的一系列大气观测数据。[1]因为观测的需要，气象卫星具有众多的波段，而对这些波段进行配准，直接决定了图像的质量。
			这篇文章的结论是基于“风云三号”卫星系列中的FY-3D卫星和“风云四号”卫星系列中的FY-4A卫星
			1.2.1.2 FY-3D MERSI-II
			FY-3卫星是风云一号卫星基础上发展起来的新一代极轨气象卫星[2]，此卫星系列已被世界气象组织纳入了新一代气象卫星网。风云3D是一个极轨卫星，运行高度863km，轨道倾角98.753°，轨道回归时间约4-10天，风云三号D星设计寿命5年，装载10台套遥感仪器，包括：中分辨率光谱成像仪、微波温度计、微波湿度计、红外高光谱大气探测仪、微波成像仪、近红外高光谱温室气体监测仪等。
			[FIG.1]
			其上搭载的中分辨率光谱成像仪（下称MERSI-II）是FY-3D卫星上最重要的仪器之一，在MERSI-I基础上改进之后，性能可以与美国最新的联合极轨气象卫星相当，是国际上最先进的宽幅成像遥感仪器之一。
			MERSI-II采用了多元探测器并扫的方式，通过光机扫描获取星下宽视场信息，分色分通道获取地物和大气的信息。对不同波段配备10元或40元探测器，扫描镜每扫描一圈，在卫星前进方向扫过10条/40条扫描线，对应分辨率1000/250m，每扫描一周可以依次观测冷空间/地前空间/地球边缘至边缘/可见光/近红外/长波红外星上定标器，全系统有20个波段，波段信息如下
			[FIG.2]
			1.2.1.3 FY-4A卫星
			2016年12月11日0点11分我国新一代静止轨道气象卫星风云四号的首发星在西昌卫星发射中心由长征三号乙运载火箭发射升空。12月17日下午，卫星定点成功。[10]风云四号卫星是我国第二代地球静止轨道（GEO）定量遥感气象卫星，采用三轴稳定控制方案，将接替自旋稳定的风云二号（FY一2）卫星，其连续、稳定运行将大幅提升我国静止轨道气象卫星探测水平。[12]
			风云四号A星上搭载了众多载荷，包括多通道扫描成像辐射计、干涉式大气垂直探测仪、闪电成像仪、空间环境监测仪器包和微波探测试验载荷等。其中最重要的载荷之一，也是本文的研究对象，多通道扫描成像辐射计，共有14给通道，覆盖了可见光到红外的众多波段，探测性能也可以与欧美第三代气象卫星相媲美。[12]辐射计采用光机扫描方式成像，通过星上补偿和卫星自选抵消转镜力矩，一次15分钟的扫描得到整个全圆盘图像。另外加装了小区域扫描功能，可以在一分钟内扫描边长1000km的矩形图像，可以用于观测区域强灾害天气。而数据量化等级也由6-8bits提高到了10bits[13]。
			风云四号的波段信息如下：
			[FIG.3 风四波段图]
				[待补充]

		1.2.2 配准方法现状
			关于像元级别的配准算法已经有众多的成熟算法，而由于卫星各个波段焦平面位置的细微误差可能造成亚像元级别的误	差，虽然在像元级配准之后能达到一定的精确度，但仍然会在波段众多的情况下造成图像的虚化。在这样的情形下，需要开发一种亚像元配准的算法。而由于这种算法需要兼顾各个波段和各种区域的图像，所以需要一种较为一般而不是特化的方法。
			像元级别配准方法已经逐渐成熟，所以可以直接应用某些配准方法对亚像元精度的图像进行配准。一般的亚像素配准方法有如下几种：最小二乘曲面拟合算法，像素插值移动算法，迭代插值曲面拟合方法，这几种算法都对计算机性能有着较高的要求。[3] 超分辨率重建需要从多帧低精度图像中估计高精度原图像。1.泰勒展开参数估计法，计算量小，理论简单，速度快。2.频域参数估计算法,傅里叶变换具有平移不变特性，可以用来估计平移参数和旋转参数。主要有两种形式，Vanewalle等人提出的算法[4]，或者基于相位相关的算法。3.金字塔分解算法,也称多尺度分解算法，是将图像分解为不同尺度的子图像估计的方法。[5] 其他方法有基于特征提取的图像配准；基于相位相关的频域配准；基于像素灰度值配准。特征提取速度快但误差大，相位方法需要较大的重叠像素数，灰度匹配方法准确度较高，一般采用的技术有ABS/欧氏距离/互相关/互信息/条件熵/联合熵等[6]
			而从信息论角度出发的算法，如互相关[7]，互信息[8]，互信息及其变化率[9]的算法，稳定性和准确性得到了数学理论层面的证明，故应用较多，也较为成熟。
		1.2.3 重采样方法研究现状
			在亚像元配准之前，需要进行插值使得图像达到亚像元精度。这个过程也称为重采样。重采样是指根据一类象元的信息内插出另一类象元信息的过程。在遥感中，重采样是从高分辨率遥感影像中提取出低分辨率影像的过程。常用的重采样方法有最邻近内插法(nearest neighbor interpolation)、双线性内插法(bilinear interpolation)和三次卷积法内插(cubic convolution interpolation)等。
			三次卷积内插法是一种精度较高的方法，同时运算量较大，它是通过增加参与内插计算的邻近像元的数目来达到最佳的重采样效果。但是算法冗杂，计算量较大，与双线性内插法类似，会改变原来的栅格值，甚至可能会超出输入栅格的边界范围。是一种适用于航片和传统遥感影像的重采样。[3]
			而计算量较小的重采样算法包括最近邻点法，双线性插值法，临点权重插值法，二次/三次曲线拟合法等。
	1.3 研究目标和路线
		1.3.1 研究目标
			1.3.1.1 对卫星图像的配准及其效果评价
			开发了算法之后，就需要对卫星上拍摄得到的多光谱卫星图像进行配准效果评价。这个算法最后应当应用到卫星图像上，对卫星遥感图像的配准效果进行评价，并最后得到卫星图像的亚像元配准评价结果。这一步的主要目的是得到一个关于风三图像和风四图像的配准效果评价，是应用算法对图像质量本身的评价
			1.3.1.2 对人工模拟误差的校正
			为了验证算法得到的卫星图像配准是否能达到算法标称的精度，还需要在配准现实图像之外，人工制造误差并进行校正。如果算法能够准确地探测到人为增加的误差，那么可以基本推断算法的精度可以达到重采样之后标称的精度。这一步是为了验证算法的性能，并可以由这个结果验证算法是否能达到算法原理里的标称精度。
			1.3.1.3 对算法本身性能的验证
			通过对比这个算法与其他作者的算法效果和对同一个图像的配准评价结果，可以得到这个算法的一致性。通过对比这个算法和其他算法配准效果在合成图像效果上的差异以及本算法在合成图像效果上相较于原图像的改善，可以得到这个算法的有效性。通过应用算法到不同的图像上，再对比这些图像之间的效果差异和结果差异，可以得到这个算法的稳定性。这都是对算法配准评价性能的评价与验证。
		1.3.2 方案采取的技术路线
			本方案采取的整体路线如下。先将图像根据遥感图像的扫描特性，对图像进行小块的划分。然后对这些图像都进行一种叫做归一化互信息（NMI）的处理。在处理的同时对图像进行间隔为1像素的相对位移并裁切下重合部分。由此得到相对位移所对应的NMI值，为一个矩阵的形式。之后进入筛选环节。第一次筛选选用矩阵中的NMI最大值阈值筛选图像。第二次选用NMI与其周边值的差值作为筛选条件，第三次选用图像切片的平均亮度作为图像筛选条件。
			得到筛选之后的图像切片之后，对这些切片进行二次配准评价。将这些切片进行10倍重采样，使其精度到达0.1个像素，然后对这些图像进行相对0.1像素的位移，得到NMI峰值的对应位置，将这个位置对应的位移量作为这个切片的误差评估值。最终将这些切片的误差评估值作平均得到最后的评价结果。
		1.3.3 技术流程图
			[Fig.技术流程图]
	1.4 本文主要研究内容
			4.通过独立方案对重采样后的通道配准精度，以及亚像元配准对图像合成质量提升效果
		1.4.1 详细了解风云卫星的图像数据结构和卫星概况
			在针对卫星遥感图像进行算法开发之前，首先需要详细了解风云卫星的图像数据结构，这样设计的算法才能更好的适应风云卫星图像的各类特性。而了解卫星概况也可以在设计算法的物理意义方面给予一些参考。
		1.4.2 对卫星图像进行评价
			选择合适的地球目标，提取月球观测资料，根据MERSI焦平面分布进行图像相关分析，建立亚像元级配准参数计算模型，计算亚像元级配准参数，对MERSI业务配准精度和稳定性进行评价。将实验中开发的算法应用到风三以及风四图像上来计算图像的配准效果。
		1.4.3 建立重采样算法
			建立亚像元级重采样算法，根据配准参数进行图像重采样。本文使用最近邻点插值法，将图像的精度增加到了0.1像素，在此基础上进行配准评价工作。
		1.4.4 算法的主体流程
			总体的方案，除去一些周边工作，算法主体结构分成三个部分，分别承载不同作用。
			1.4.4.1 对图像进行预处理
			我们首先需要对图像进行一些预处理，这样可以使得数据结构从预设形态转换成我们需要的形态，并提取其中对开发工作重要的信息。
			预处理工作分成如下几个部分
			1.读取卫星数据
			卫星遥感图像的数据格式为HDF，而这一步需要将HDF的外部数据读入进入python，这里需要python环境安装HDF相关的库文件
			2.对数据进行定标
			卫星遥感图像的原始数据DN值各通道是不在一个响应范围的，需要将图像DN值进行定标，以使各波段图像合成的时候不会出现整体偏色，局部过曝等现象。
			3.对数据进行切割
			这一步是用来预先挑选图像中对于配准算法配合较好的区域，同时通过分块计算避免整幅图像计算的结果偶然波动问题。
			1.4.4.2 对图像进行重采样
			对图像进行重采样是从像元级配准转化到亚像元配准的重要过程。重采样可以增强图像分辨率，使得微小的差别被拉大，也可以使得图像之间可以进行亚像元的相对移动而不损失信息。而重采样算法的精细度也决定了图像之间相对移动的最高精度。借由这种方法，我们可以得以纠正图像之间的亚像元拖影。
			1.4.4.3 对图像进行配准评价
			对图像进行重采样到更高精度之后，就可以对图像进行亚像元配准工作了。通过逐像素移动重采样图像，可以得到图像配准效果最佳的位置，以此得出图像配准评价的相关参数。
		1.4.5 评价配准效果
			通过独立方案对重采样后的通道配准精度，以及亚像元配准对图像合成质量提升效果评价。这一步使用与其他算法的对比，和原本图像之间的差异，得出算法对图像合成质量提升效果评价。
二. 数据与工具
	2.1 概述
		在算法设计与编写开始前，首先要了解卫星图像的数据结构，才能对应其特点开发对应的配准算法。要编写算法，首先要了解学习工具的使用。要验证算法，也需要对应的应用软件来实现相应功能。
		本章首先介绍了FY-3D-MERSI-II和FY-4A的图像数据格式以及其数据结构，及其对应的数据初步处理方法，然后介绍了本次设计中用到的三个主要软件，第一个软件是在算法设计环节以及贯穿之后编写阶段的卫星数据查看工具————HDFView，这个软件可以帮助我们分析卫星图像的数据结构，其次是算法编写阶段使用的语言python以及其集成开发环境————pycharm和spyder，然后是在算法验证阶段使用的专业卫星遥感图像查看软件————ENVI，最后对这些软件和数据结构做出了总结。
	2.2 卫星遥感数据
		2.2.1 FY-3D MERSI-II
			2.2.1.1 载荷设计与观测原理
			风云三号气象卫星是我国第二代极轨气象卫星，可以对地球大气，地物，云层进行多光谱，多高度三维检测。中分辨率光谱成像仪II型（MERSI-II）是风云三号D星的主要载荷之一，共配备25个通道，包括16个可见光-近红外通道，3个短波红外通道和6个中长波红外通道。MERSI-II主要任务是实时监测海洋，大气，陆地等环境要素，提高天气预报，气候变化研究，环境监测等观测能力。
			MERSI-II使用扫描镜和消旋镜配合的方式对地球进行观测，每次扫描约能扫出2900kmx10km的一个扫描带，结合卫星相对地球的飞行，能实现对全球表面每日扫描的覆盖。成像仪采用10元/40元并扫方式，分辨率分别能达到1km/250m。成像仪中有6个通道为250m分辨率，19个通道为1km。
			MERSI-II的成像方式是推扫式成像，每一幅五分钟图像由若干幅单次扫描长条图像构成，每一次转镜扫描可以扫出一条10像素或40像素宽的条带，随着卫星的飞行，扫描出一幅连续的图像。
			一幅5分钟，精度为1km图像的单幅图像分辨率为2000x2048。为200个单次扫描条带构成。
			2.2.1.2 数据结构
			MERSI-II采用的数据格式为遥感卫星通用的HDF文件格式，为HDF的第五代文件版本。HDF文件的数据结构为树状，文件下包括若干数据组（group），每个数据组下包括若干个数据集（dataset），数据集即为卫星遥感的原数据。
			MERSI-II的数据结构如下:
			数据整体分为四个部分,每个部分承担不同功能。
			calibration，这一部分储存了关于数据定标相关的内容，和星上设备在扫描时的相关信息
			1.Frame_Count，表示扫描帧计数信息。
			2.EV_start_time，表示EV起始时间。
			3.Kmirror_Side，表示K镜镜面标识。
			4.BB_DN_average，表示黑体计数值的平均值。
			5.SV_DN_average，表示冷空计数值平均值。
			6.IR_Cal_Coeff，表示红外通道定标系数。
			7.VIS_Cal_Ceff，表示可见光通道定标系数。这一数据在数据的预处理中会有所应用。
			Data，这一部分是数据的主体部分，也是遥感图像的原数据。数据分为四个部分。
			1.EV_250_Aggr.1KM_RefSB，为1-4通道，主要包括三种三原色可见光波段，和一个865nm的近红外波段。这个波段的原数据精确度在250m，为了工作时配合其他波段图像，经过重采样之后的精确度为1km。为地面反射波段，用作探测陆地，云边界和地物特征遥感。
			2.EV_1KM_RefSB，为5-19通道，主要是各种地物特征和海洋特征波段，波长从412nm到2.13um不等，这个波段的精度在1km左右，承担了陆地，云边界和地物特征遥感，海洋水色，浮游生物，生物地球化学遥感，大气水汽和卷云探测等作用。
			3.EV_1KM_Emissive，为20-23通道，为红外成像通道，承担探测陆地，水云温度，大气和水汽情况等功能，精度在1km左右。
			4.EV_250_Aggr.1KM_Emissive，为24，25通道，是两个远红外波段，波长分别为10.8和12um，这个波段的原数据精确度在250m，为了工作时配合其他波段图像，经过重采样之后的精确度为1km。这个波段主要承载探测陆地水云温度的作用。
			Geolocation，这个数据集表示的是图像的地理位置相关数据。这一部分包括两个部分。
			1.Latitude，表示扫描图像每隔20像元的纬度信息。
			2.Longtitude，表示扫描图像每隔20像元对应的经度。
			QA，这个数据组表达的是扫描帧预处理的质量标识值，其中也只有一个数据集表示此标志。

			[fig.数据结构图]

			2.2.1.3 处理方法
			通过python中的h5py库可以读取HDF文件到内存中作为一个文件对象，然后取其中的数据组Data，再分别读取其中的各个数据集，最终读取的数据集为几个多层数组。原数据的DN值为星上仪器焦平面上的感应元件直接读出的响应值。而这个响应值并不直接等于探测的亮度，所以需要结合calibration数据集中的定标参数进行定标工作。
		2.2.2 FY-4A
			2.2.2.1 载荷设计与观测原理
			风云四号卫星为风云二号的改进升级版本，也是我国的第二代同步轨道气象卫星。FY-4卫星的成像通道由原来FY-2G的5个增加到了14个，覆盖了从可见光直到红外光的多光谱波段，已经接近欧美的第三代气象卫星的16通道配置。星上辐射定标精度0.5K，达到了在同步轨道的高度上，可见光波段空间分辨率为0.5km，相当于在数公里之外的距离上，准确地探测几枚火柴的光亮。[14]
			风云四号星载的扫描成像辐射计相较于风云二号有了多个方面的改进，包括波段数量的扩展，圆盘成像的时间也有所缩短。另外增加了小范围扫描功能，分辨率，量化等级等性能都有了进一步提高。
			风云四号卫星的扫描方式为推扫式成像。利用卫星的自旋运动和扫描镜的移动来对全地球图像进行成像。[13]一次成像为25分钟，每一次成像可以获得同步轨道视野的全地球圆盘图像。
			系统主要包括几个部分：
			1.光学系统，其中有主光学成像系统，不同通道之间的光路分离组件，各式中间棱镜透镜，辐射致冷器等。
			2.光机扫描系统，包括转镜，支持结构，扫描控制及传感器等。
			3.多像元探测器，包括从可见光到远红外的12个波段。
			4.星载电子器件，包括各类控制器，电源，温度传感器，地面控制信号接收器等。
			5.星上定标系统，包括各类不同波段的黑体定标器件。
			6.热控系统，实现对星载仪器的各部分的主动或被动温度控制。[13]
			2.2.2.2 观测通道与数据结构
			FY-4A的数据采用的是HDF5文件，文件内不分数据组，所有数据均在默认组‘/’中以数据集的方式储存。
			FY-4A的数据中每一个通道的数据都分别储存在一个一层的数据集中。命名为NOMchannel+数字的方式。大小为2748x2748
			FY-4A的数据中的每一个通道都有分别对应的一个定标数据，也分别储存在一个一层的数据组中，其中每一行代表原图像一个特定的DN值。大小随着图像的有效值范围不同而变化。
			[待补充]

			2.2.2.3 处理方法
			通过python中的h5py库可以读取HDF文件到内存中作为一个文件对象，然后分别读取其中的各个数据集，最终读取的原始图像数据集为14个单层数组。原数据的DN值为星上仪器焦平面上的感应元件直接读出的响应值。而这个响应值并不直接等于探测的亮度，所以需要结合每个通道分别对应的数据集中的定标参数进行定标工作。
	2.3 处理工具
		2.3.1 HDFview
			HDFview是一个简易的读取HDF文件的工具，操作性强，功能简单易用。HDFview可以逐像素位置读取HDF文件中的数据值，也可以对文件做增删操作等。在本次研究中，主要承担查看数据结构，验证数据操作效果，查看数据大小和特定位置数据值，简易绘图功能等。本文采用的是HDFVIEW3.1.0版本，界面如下图所示：
			
			[fig.界面示意图]
			
			HDFview可以打开单个数据集，并对其做绘图，查看数据属性或者查看数据值操作，如下图所示：
			
			[fig.数据查看与绘图，属性查看]
		
		2.3.2 python
			python是一个高层次的结合了解释性、编译性、互动性和面向对象的脚本语言。python支持跨平台应用，是目前应用最广的跨平台脚本语言之一。python最大的优势是可以加载大量的第三方库，例如numpy，matplotlib，opencv等，这些库由第三方开发者编写，可以在社区自由发布。各种著名的跨平台库都对python有自己的接口。
			python语言由于本身的简洁性和强大的扩展性，使其在各种领域都能有自己的应用，例如数值计算，图像处理，深度学习等领域，python都是首选的编程语言之一。
			对于此次研究，用到了下列的一些库：
			h5py：为了读取HDF5文件，在这个python程序中应用了一种叫做h5py的库。这个库可以将HDF文件读取为一个H5文件对象，之后使用h5py库的内建方法可以将h5文件内的数据组读出，并进一步读出数据组下的数据集。h5py还可以对HDF文件进行增删操作，在文件中写下需要的数据。
			numpy：使用h5py读取的HDF文件中的数据集，可以作为numpy的数组对象进行处理。numpy是一个高效的数值计算库，可以应对大型数组的快速数值计算。其中内建的ndarray比python的嵌套列表高效得多。在本次研究中主要承担图像的各类数值计算，承担程序的主体功能。
			opencv：OpenCV是一个基于BSD许可（开源）发行的跨平台计算机视觉库，可以运行在Linux、Windows、Android和Mac OS操作系统上。它也提供了对python的接口，可以在python上运行。在本次研究中主要承担运行时对各类数组的绘图功能。
			pandas库：pandas是基于NumPy的一种工具，该工具是为了解决数据分析任务而创建的。Pandas纳入了大量库和一些标准的数据模型，提供了高效地操作大型数据集所需的工具。作为一个数据分析包，在本次研究中主要承担了在计算图像熵模块中的统计功能。
			multiprocessing库：python有一个非常重要的GIL（global interpreter lock，全局解释器锁）。python代码执行由python虚拟机（解释器主循环）来控制。对python虚拟机的访问由GIL控制，GIL保证同一时刻只有一个线程在执行。由于GIL的限制，python多线程实际只能运行在单核CPU。如要实现多核CPU并行，只能通过多进程的方式实现。大部分并行模块中，多进程相当于开启多个python解释器，每个解释器对应一个进程。multiprocessing库承担程序的多核优化功能，可以极大增强程序的运行速度。
		2.3.3 ENVI
			ENVI（The Environment for Visualizing Images）是一个完整的遥感图像处理平台，应用汇集中的软件处理技术覆盖了图像数据的输入/输出、图像定标、图像增强、纠正、正射校正、镶嵌、数据融合以及各种变换、信息提取、图像分类、基于知识的决策树分类、与GIS的整合、DEM及地形信息提取、雷达数据处理、三维立体显示分析。
			ENVI可以对图像进行各种可以细致调节参数的增强操作，并可以对图像进行细致高效地比对。在这里我们可以使用ENVI对图像进行增强并评价配准方法的效果。
三. 亚像元配准模型的建立
	3.1概述
		模型的建立需要结合需求和数据等多个方面。本次实验的模型建立，首先从像元级配准方式出发。图像的配准效果，也就对应着特定位置的图像相关性，所以采用了归一化互信息（NMI）的方法，作为配准效果的依据。然后由于普通的像元级配准方法无法得到小于一个像素的配准评价，而原图像也无法进行亚像元级的相对移动，所以需要对图像进行重采样，使得图像的分辨率从原来的单个像素扩展到0.1个像素。这样，就达成了使图像可以采取亚像素相对移动的方法。在图像的精度到达了0.1像素之后，就可以开始对重采样后的图像进行精度为0.1像素的配准评价。配准-重采样-再配准，就是整个研究方案的主体思路。
	3.2 归一化互信息（NMI）
		归一化互信息（NMI）方法是整个研究方法的核心指标，也是本文作为配准效果的标准。对归一化互信息的实现是本研究的重要内容之一。
		3.2.1 归一化互信息的数学定义
			归一化互信息是表达两个随机变量之间的相关性的量。
			对于两幅图像A,B，归一化互信息的表达式是H(A)+H(B)/H(AB)
			其中H(A)=-ΣPA(a)logPA(a),H(B)公式形式与其相同。
			公式中PA(a)表示的是在A图像中，a灰度出现的概率。概率是一个关于随机变量的参数。而在归一化互信息应用于确定的图像上的时候，这个概率应解释为特定灰度a在图像A中出现的频率。这个频率需要归一化。这个灰度出现的频率可以理解为图像灰度直方图上的灰度对应的柱状图高度。
			其中H(AB)=-ΣPAB(a,b)log2PAB(a,b)
			公式中的PAB(a,b)指的是在某个特定位置上，在A图像对应位置灰度为a的同时B图像对应位置灰度为b的概率。
			在表达上可以采用联合灰度直方图的形式。将A图像的灰度级别作为矩阵的0轴，将B图像的灰度级别作为矩阵的1轴，然后遍历整个图像的每一个位置，假设某位置对应A图像灰度为a，对应B图像灰度为b，那么这个位置就对应联合灰度直方图上(a,b)的一个概率值。
			通过这种方法，最后可以统计出每个a灰度对应b灰度的概率，所有的a,b灰度对所对应的概率，构成了完整的联合灰度直方图。而这个灰度直方图上每个a,b对所对应的概率，就是上述公式中的PAB(a,b)
		3.2.2 归一化互信息的物理意义
			归一化互信息(Normalized Mutual Information)是互信息(Mutual Information)的归一化形式，弥补了互信息具有量纲的一个不足。互信息的公式为H(A)+H(B)-H(A,B),量纲为bit，其中的H(A),H(B),H(A,B)的定义与归一化互信息相同。H(A)与H(B)的物理意义为图像（随机变量）A,B所含的信息量，而H(A,B)表达的是图像A,B均已知的情况下所能得到的信息总量。因为P(A)，P(B)表达了A,B中每个图象分别的所有灰度的概率分布，所以H(A),H(B)表达了A,B图像所含的信息量。而P(A,B)表达了A,B之间所有灰度对可能出现的概率，所以包含了A,B能表达的所有信息。因为灰度排列本身随机，但在联合灰度直方图中，灰度与位置建立了关系，灰度对表示从一幅图像特定位置的特定灰度可以推断出另一幅图像可能在这个位置的灰度分布。这样两幅图像的信息不是完全独立的，其中会有灰度之间互相推断的概率关系，即A每个特定灰度所在行独立抽出就是一个完整的灰度直方图，而联合灰度直方图由A的所有灰度所对应的直方图所拼接而成。由此，P(A,B)表达了两幅图像的总信息。

			[fig.信息量之间关系venn图与信息量表达NMI和MI]
			
			所以互信息的表达式表达了两幅图像分别的信息量之和减去两幅图像的总信息量，这个量表达的是两幅图像之间重合的信息量，故称之为互信息，这个量是带量纲的，与信息量纲相同。而归一化互信息，则是将两幅图像分别的信息量之和除以两幅图像的总信息量，这个量由于表达式是信息除以信息，所以是一个无量纲量。而两幅图像分别的信息量之和必然大于两幅图像的总信息量，因为两幅图像不能提供自身所含的总信息之外的信息。而两幅图像的总信息量也绝不可能小于某一幅图像单独的信息量，因为多知道了另一幅图像不会导致丢失信息。由于这个原因，归一化互信息的取值范围为1-2。NMI=1表示两幅图像的各自信息量之和与同时知道两幅图像的总信息量相同，也表达两幅图像之间没有重合的信息，两个图像之间完全独立，没有相关性。而如果NMI=2的时候，表达的物理意义则是两幅图像的总信息量和两幅图像各自的信息量相等，在得知了第二幅图像之后没有获得任何额外信息，代表两幅图像完全相关，也即在得知第一幅图象之后就可以逐像素得知第二幅图像的像素值，A图像的每个特定灰度a都与B图像的某个特定灰度b相关。
			而归一化互信息作为一个无量纲量，相比单纯的互信息方法具有的优势是归一化互信息值不会受到图像本身大小，即图像本身含有的信息量量级的影响，而单纯的互信息值会受到原图像信息量的影响。这样，无论是切割分割图像的操作，还是图像之间互相进行相对位移取重合部分导致用于计算的图像大小发生变化，从理论上都不会对于归一化互信息的值产生影响。这一点也是将NMI作为判断图像配准效果的评价标准的依据之一。
	3.3 邻点权重法重采样
		重采样方法是指根据一类像元的信息内插出另一类象元信息的过程。而这个内插可以由低分辨率向高分辨率插值，也可以从高分辨率采样低分辨率图像，在本次实验中，重采样是根据低分辨率图像重采样出高分辨率图像。而采用的重采样方法是邻点权重法。
		邻点权重法是一种结合周围若干个原图像像素值来计算插值点值的一种重采样方法。邻点权重法是一种计算速度快，插值效果较好的方法。
		邻点权重法相对于深度学习等机器学习方法，优势在于不会因为算法产生原来的遥感图像信息以外的新信息（这会导致图像失真），也不会丢失原图像的信息（这会导致不能充分利用图像信息）。是一种适用于遥感图像分析与增强的插值方法，而这种方法配合以信息论为基础的归一化互信息方法，可以保证图像信息的充分利用。
		邻点权重法作为传统的插值方法有一个缺点，即在某些数据点位置分布不均匀的图像上，难以确定使用的邻点范围，而计算距离的公式也相对麻烦，需要消耗大量算力。但是在数据排列高度规整的遥感图像上，选择邻点和计算邻点距离都相对简单，消耗的算力会极大减少。
		3.3.1 邻点权重法的数学定义
			邻点权重法分为如下几步。
			1.使用距离公式计算与各邻点的距离，此处使用欧氏距离作为邻点距离的数值。公式为
			hi=√((x-xi)^2+(y-yi)^2)，其中(x,y)为插值点的坐标，(xi,yi)为插值点所用的第i个离散邻点的坐标。
			2.使用幂参数计算权重函数，公式如下：
			wi=hi^(-P)/Σhi(-P)
			其中P为幂参数，P越大，更靠近的邻点所占权重指数就越大。P为1时接近于双线性插值，P趋于无穷时接近于最近邻点法。
			3.计算插值点值
			Z(x,y)=Σwi*Z(xi,yi)
			[插值图像示意图]
			邻点权重法重采样不同于最近邻点法直接复制值，最近邻点法插值在规整的网格图像上只能达到像素放大效果，基本无法进行亚像素配准工作，而邻点权重法在不损失信息的情况下，使得不同像素之间的灰度平滑过渡，更好配合配准工作。
		3.3.2 重采样的作用
			重采样可以提高图像分辨率，使得图像配准评价时可以让图像进行亚像元的相对移动。而重采样的精确度也决定了图像进行亚像元移动的精度。在本次实验中，重采样的精确度达到了0.1像素。
		3.3.3 邻点权重法的效果评价
			[fig.不同权重系数的插值效果图]
			经过对比实验，不断调整邻点权重系数，发现权重系数定为1，3，4时图像都会有不同程度的模糊或者锯齿，而P=2的时候插值效果较佳，图像相对平滑又保留了较多的纹理，所以最后采用P=2作为邻点权重系数。
	3.4 集成模型
		3.4.1 位移后图像矩阵的构建方法
			图像需要进行逐像素的相对位移，而图像之间NMI的计算需要要求图像的大小相同，故需要让图像相对移动之后取两幅图像的重合部分来作为下一步计算NMI的部分。
			如下图所示，A图和B图之间大小相等，然后对A图和B图之间进行相对位移，最后取A图和B图之间的重合部分切片，作为新的图像矩阵。
		
			[fig.位移矩阵]
		
		3.4.2 图像位移与NMI的结合
			图像位移和NMI的结合是算法中的核心部分。在不同通道的图像切片之后对这些通道的图像进行最佳配准位置的判断时，就需要将位移矩阵和NMI结合起来。先确定一个位移的范围，然后建立一个和位移范围等大的矩阵。如图像需要进行(-3,-3)到(3,3)的逐像素位移，则需要建立一个7x7的矩阵，矩阵每个单元分别对应一种位移的情况。然后对图像矩阵进行上述的相对位移操作和切割，再对每一种位移和切割情况计算一次NMI，将每次NMI值对应写入这个与位移范围等大的矩阵的每一个对应位置。最后，就可以得到每种不同位移情况对应的NMI，即相关性，将峰值NMI对应的位置，即相关性最强的位置作为评价的最佳配准效果位置。通过这样图像位移与NMI的配合，就可以得到关于一幅图像的配准评价。
		3.4.3 图像矩阵位移对NMI的影响
			图像矩阵位移，将不同的通道图像之间进行了相对位移，图像配准的相关性会产生变化。同时，图像位移矩阵的构建，会引起图像矩阵大小的改变，而图像的切割会引起图像熵量值的变化。如果采用一般互信息(NI)，在切割图像时图像熵的变化会改变互信息值，但在采用归一化互信息(NMI)的方法中，图像熵值数量的变化理论上不会引起NMI的变化，也就是说NMI只反映两幅图像的相关程度。但是在图像相对小的情况下，切割图像会引起图像大小的量级变化，这会增加图像之间相关性本身的不稳定性，容易受到少数随机误差的影响而得出错误的配准评价位置判断。所以在图像进行位移NMI计算时，要注意图像切片大小不能过小，避免为实验结果增加不稳定性。

	3.5 小结
		本章是整个实验流程的理论前提。本章主要描述了整个方案依靠的各项数学公式，以及它们分别的实现方法。先通过归一化互信息(NMI)的方法来获得图像之间的相关性并将它作为图像配准效果的评价标准，通过位移矩阵NMI方法得到像素级的配准评价标准，然后采取邻点权重法的方法来对图像进行插值，使得图像可以将精确度提高到0.1像素，并为之后的亚像素相对移动图像提供了条件。在图像的精确度被提高到0.1像素之后，就可以将图像NMI和图像之间的相对位移和切割结合起来计算图像的最佳配准位置。图像的配准效果由此方法得出，此算法也用这种方法对遥感图像进行配准评价。
四. 实验方案与处理流程
	4.1 实验方法的流程与建立
	本次研究的主题是亚像元重采样，首先需要将图像配准到像元级别。所以在进行亚像元配准之前，需要首先对图像配准到像元级别。在这一步笔者采用了对图像整体进行归一化互信息方法配准。而在像元级重采样完成后，意味着图像只存在亚像元级别的误差。而像元级精度的图像无法进行亚像素级别的相对移动，所以需要人为增加图像的分辨率，这一步即为重采样的过程。使用重采样将图像重采样到0.1或0.2给像素的精度之后，这些图像之间就可以进行亚像素级别的相对移动了。之后就可以采用位移NMI方法判别图像的亚像元配准情况。为了提高算法时间性能以及提高结果稳定性，采用了在预处理时对图像进行切片的方法，最后在计算结果的时候将它们进行一个平均，作为最后配准效果的评价标准。
	4.2 NMI方法的实现
	NMI算法的实现，是整个研究工作中最重要的内容之一，而NMI的算法实现也是在本次研究中不断优化的。
	首先，NMI的计算分为三步。第一步，计算两幅图像的单幅信息熵。第二步，计算两幅图像的联合熵。第三步，计算图像的归一化互信息。
		4.2.1 单幅图像熵的计算
			单幅图像熵的计算，需要建立一个图像的灰度直方矩阵。通过遍历图像的每一个像素，并把其像素值写入对应的直方图矩阵里，就可以得到灰度直方矩阵。将灰度直方矩阵最后统计出的频率值经过3.2.1所述图像熵的公式计算，即可得到单幅图像的熵值。这里采用了pandas库直接统计各个灰度对应的频率，提升了统计的速度。
		4.2.2 两幅图像的联合熵计算
			联合熵的计算比单幅图像熵的计算复杂得多。首先，它的灰度直方矩阵大小不是图像熵的一维形式，而是二维的，大小为两幅图像的灰度最大值的乘积，每个轴的长度分别对应一幅图像的灰度值。

			[fig.联合灰度直方图的构建方法]

			将两个图像合并成为一个两层的三维数组，每一层对应一幅图像。遍历两幅图像的每一个位置，分别记录这个位置对应的两幅图像的灰度值，然后将这个灰度对对应联合灰度直方矩阵的相应位置计入频率。最后遍历这个灰度直方矩阵，通过3.2.1所述联合熵公式得到联合熵值。但是建立联合灰度直方矩阵需要的空间太大，每次计算联合熵需要遍历数百万计的数组元素，遍历太慢，所以需要有一种更加快速的统计方式。
			4.2.2.1 pandas库+进制变换
			pandas库的统计方法简便而快捷，但是有一个缺点是只能统计单一维度的列表，不能统计“灰度对”这种包含多个元素的对象。所以需要一种方法，使得灰度对变换成一个只含单一元素的对象，把含有两列的灰度对矩阵变换成一维矩阵。
			通过一种进制变换的方式，笔者成功将一个二维的联合灰度直方图变换成了一个一维的浮点数矩阵。
			将一个维度的灰度最大值（此处采用第二幅图像的灰度作为例子）作为“进制”，将第一列灰度乘以这个“进制”之后加上另一列的灰度值，即可以将两列灰度值转换成一列“多位灰度值”，这样，可以在一个浮点数里包含两个数字的信息，并且不会产生相互串扰。这个进制转换过程也是可逆的。
			例如拼接前的灰度矩阵为
			[22 21 20 ...    0    0    0]
			[ 8 16 24 ...    0    0    0]
			而第二列数组的最大值为100，这个时候就可以将两列数字转换成一个“两位的100进制数”，即
			[2208 2116 2024 ...    0    0    0]
			这样，就可以利用pandas库高效的统计功能对图像灰度对进行统计了。
			此统计方法可以推广到更多维度的更多情形，而将浮点数改为字符串可以解决数据类型记位上限问题。
			改进后用pandas统计的NMI方法比直接遍历统计的方法快100倍左右，在python环境中实现了接近C语言的计算速度，保证了算法的实时性。
		4.2.3 归一化互信息计算
			将通过统计得出的两幅图像单幅图像熵相加，除以两幅图像的联合熵即可得到图像的归一化互信息(NMI)值。
	4.3 对图像进行预配准（像元级）
	在进行亚像元配准工作之前，我们要先对图像的像素级图像进行像素级配准。由于风三和风四图像的像元级配准已经在传回数据后在地面完成，这一步是验证性的工作。将整幅5分钟图像进行位移NMI配准评价，然后得到一个关于位移的NMI矩阵。在设计这一步时，同时也是在验证NMI算法对图像配准的稳定性。经过计算多幅图像，这些图像均没有像素级误差。鉴于原图像不存在像元级误差，可以直接采用原图像进行下一步工作。
	4.4 对图像进行预处理
	在像元级误差确认后，就可以正式进入亚像元配准工作。首先需要对图像进行预处理，以适应后续算法，以及配合图像和卫星的成像方式。预处理也能配合算法达成更好的性能优化。
		4.4.1 对图像进行切片的方法及其意义
			在图像进行像元级配准的时候，我们的算法是直接对整幅图像进行像元级配准，这样的作法是基于计算机计算性能足够对应原图像2000x2048的矩阵计算，而当像元级配准完成之后，就需要进行亚像元配准，亚像元配准之前需要先对图像进行重采样工作。要将原图像1像素的精度提升到0.1个像素的精度，需要对图像进行10倍的重采样，而每一幅重采样之后的最后图像所占内存就会达到原图像的100倍，每一幅单通道重采样图像所占内存有数个GB的量级，甚至连重采样方法的中间辅助数组都能达到500M左右的量级，非常容易造成内存的溢出，而这种巨大数组的计算对于计算机的算力也开销巨大，实时性也无法保证。为了解决这个重采样消耗内存的问题，笔者采取了将图像在重采样之前预先切片的方法，以避免将整个图像数组全部进行重采样。
			而对图像进行切片的方法，也不是随意切割，而是需要结合卫星的成像方式来进行图像分割。故对于不同的卫星图像，笔者采取了不同的分割方式。
			风云三号D星上的MERSI-II成像方式是推扫成像并且是多元并扫，采用10元/40元扫描方式。所以在风三图像的上面可以清晰见到飞行方向每隔10个像素就会有一条明显的突变。这就是10元并扫造成的。而突变条带会给图像配准带来不利影响，所以我们将图像在飞行方向采用10个像素为单位的分割。这样就可以消除图像并扫带来的对配准的影响。而在扫描方向，采用接近飞行方向2倍的像素，2048的因数16，作为扫描方向的分割方式。最后根据这种方法，将一幅2000x2048的图像变成200x128x10x16的一个分割的小图像集合。
			而风云四号A星上采用的是步进扫描方式，而扫描单元采用的是4元并扫，而扫描条带比较密也没有扫描条带之间的突变。所以采用4的倍数12像素作为扫描方向和步进方向的切割间隔。最后将一幅2748x2748的图像分割成一幅229x229x12x12的小图像集合。
		4.4.2 对图像切片进行位移NMI计算
			在对全幅图像进行切片之后，先对图像未经重采样的切片分别进行位移NMI计算。这些切片的大小都为10x16或者12x12的小面积切片，在进行NMI计算的时候比重采样后的大图像要快得多。由于这些图像是未经重采样的图像，一般而言，NMI最大值也在无位移处，所以对这些切片图像也进行(-3,-3)到(3,3)共(7,7)大小的位移，分别计算NMI，得到每个切片对于不同位移量的NMI值矩阵，为后续的切片筛选做准备。
		4.4.3 NMI阈值筛选及其物理意义
			我们在切片之后，需要筛选配准较好的图像进行进一步的重采样配准。而NMI矩阵的最大值就是一个指标。因为NMI矩阵中的最大值代表在某个最大相关性位置的相关性大小。在前面归一化互信息的物理意义章节里已经提到过，NMI值表达的是图像相关性。NMI阈值方法可以筛选掉那些本身关联性就不大的区块，或者说本身图像间特征差异较大的区块。而更大的NMI值表示这两幅图像切片本身的相关性更好，这些相关性较高的区块一般总是特征比较相似的，有利于进一步的图像配准。
			NMI最大值阈值挑选了本身相关性较大的区块，但是未解决本身信息量较小的区块容易由于随机原因相关的问题，所以需要进一步处理。
			经过实验，采用如下方案：
			对于FY-3D MERSI-II图像，采用1.4-1.9作为NMI峰值筛选阈值。
			对于FY-4A 扫描成像辐射计图像，采用1.9-1.95作为NMI峰值筛选阈值。
		4.4.4 NMI位移斜率筛选
			4.4.4.1 数学定义
			NMI位移斜率在本文中由NMI位移矩阵的数据计算而来。数学定义为
			shiftcoeff=-(k[i+1,j]+k[i-1,j]+k[i,j-1]+k[i,j+1]-4*k[i,j])/4
			k即为位移NMI矩阵，此处假设图像NMI最大位置在(i,j)处，shiftcoeff即为此处求得的位移斜率。
			即为NMI最大值位置与其上下左右四个NMI值的差值的平均值。这个值描述了位移NMI最大值与其周边值的差异。
			4.4.4.2 物理意义
			NMI阈值筛选挑选出的切片是本身相关性较高的区块，而NMI位移斜率筛选挑选出的就是对于位移敏感的区块。只有对于位移敏感的区块，才能更好的配准，图像的相关性才与配准效果相关性大，如果NMI位移斜率低，那么表明图像对位移不敏感，也就对于配准的准确性不敏感，容易对配准工作产生负面影响，所以需要去掉NMI位移斜率低的区块。而且实践证明，NMI位移斜率大的区块，往往包含一些云层边缘，海陆边界，陆地细纹，细小云块等对于配准工作很有帮助的区块。
			
			[fig.位移NMI筛选出的区块图]
			
			经过实验，采用如下方案：
			对于FY-3D MERSI-II图像，采用0.05作为NMI位移斜率筛选阈值。
			对于FY-4A 扫描成像辐射计图像，采用0.4-0.5作为NMI位移斜率筛选阈值。
		4.4.5 图像切片亮度筛选
			预处理的最后一步，是对图像切片的平均亮度进行阈值筛选。
			在遥感图像中，经常包含一些几乎没有任何信息的海域，它们在卫星图像中几乎是纯黑的，灰度级别也非常少，而这些海域由于自身的信息量少，也比较平滑，所以NMI峰值往往比较高，由于一些随机因素也容易产生较高的位移斜率，所以需要对这些海域进行清除。而海域的共同特征是亮度低，所以采用区块亮度平均值阈值筛选的方式作为去除海域的方式。
			经过实验，采用12(255级灰度图像)作为海域的平均值阈值。低于这个阈值图像切片会被去除。
	4.5 对切片进行重采样
		接下来需要对筛选出来的切片进行重采样工作，以适应下一步位移NMI计算配准参数的工作。在此之前，需要先设计重采样算法。
		本次实验采取的重采样算法是邻点权重法。邻点权重法是一种需要结合周围所有邻点像素值的方法。所以在计算插值点值之前，需要先确定邻点的范围。
		对于不同的插值点位置，采用不同的处理方法。
		4.5.1 原图像点
			将图像扩大十倍的重采样方法，首先需要建构一个横纵轴长度都是原来的10倍的图像。这里为了便于填值和接下来标准化的选取邻点，避免特殊情况，将重采样数组的最外一层都由原图像值构成，即新数组的四角都对应原数组的四角。故横纵坐标不是简单的倍数关系，而是如下列公式所示：
			M1.shape=(M.shape[0]*p-(p-1),M.shape[1]*p-(p-1))
			上列公式中，M1.shape为插值后图像的大小，M.shape[0]和M.shape[1]分别对应原数组的横纵坐标大小，p则是重采样的倍数，根据计算机的计算性能和对重采样精度的要求可以适量调节。
			这样可以保证插值后图像的整体在原图像的框架内。而原图像向插值后的图像填值，则是直接按照隔特定的距离插值方法，将原图像值从左上角插值到右下角。

			[fig.原图像点录入示意图]

		4.5.2 格点中间数组
			中间普通的插值点的邻点参照的是附近的四个原图像信息点。即每个被原图像点及它们的横纵坐标分割的小矩形中的插值点，它们参照的点是这些小矩形的四个顶点，它们对应这四个原图像的灰度值。
			每个插值点的灰度需要独立计算，而采用坐标遍历的方法过于缓慢，所以采取了牺牲内存空间换取实时性的方法。
			笔者的方法中为这些插值点建立了多个数组，分别存放邻点信息，各点权重，再使用numpy内建的切片方法使得不同数组之间进行坐标对应，最后使得算法的性能提高了数十倍。
			这样的方法最终实现了中间插值点参照四个顶点的灰度进行邻点权重法重采样。

			[fig.中间点插值示意图]

		4.5.3 横竖网格点的计算
			除了原图像点和格点中间矩形外，还有一个部分，就是原图像点所对应的行列上，除了原图像点之外的那些普通网格点。
			这些点在10倍重采样中，都处在横或竖的整十网格上，而它们的参考点采用了上下两个原图像点或者左右两个原图像点。
			它们采取了和中心矩形插值点相似的邻点权重法插值方式。
			这里将横网格和竖网格分别计算，分别对应左右和上下两种邻点选取方式。

			[fig.横竖网格点插值示意图]

		4.5.4 将图像拼接到一起
			在这里，笔者采取了bool掩膜的方法，分别建立了中间矩形数组和横竖网格点的bool掩膜，使得它们对应不同格点所应对应的坐标位置，然后使用numpy内建的bool掩膜写入方法将格点中间数组，横竖网格点分别写入最终的重采样图像中。
			在拼接完成后尝试了不同的邻点权重指数，最后发现P=2时效果最好，没有信息丢失的模糊现象也没有锐化过度的锯齿现象，故采用P=2作为邻点权重指数。
	4.6 对重采样后的切片进行位移NMI评价
		经过上面那些经过筛选的图像重采样之后，我们就可以得到一系列经过重采样的小图像。对这些小图像进行单位为0.1像素的位移。由于原来图像的每一个像素现在都对应重采样后图像的10个像素，所以这些图像都需要上下左右各位移10次，即1像素。而位移矩阵大小为21x21，对应所有的位移情况。在某些情况下会出现不止一个位置对应NMI最大值的情况，在这种情况下直接去掉这个切片及其结果，不计入统计。
	4.7 得到最后的配准评价结果
		对每个小重采样图像进行位移NMI评价之后，需要找出每个小图像的位移NMI矩阵里所对应的最大值，将横纵坐标分别记录在两个矩阵里。最后将所有的评价出的NMI最值横纵坐标作平均，得到关于这幅图像的NMI评价。
	4.8 多进程方法提高算法实时性
		到目前为止，本文的这个算法都是基于单核运行的程序，对于现在市场主流的4核，8核，16核，以至高端的64核电脑都没有多核优化，而多核运行可以使得程序效率成倍增长，故想要提高算法实时性，提高实用性，多核性能十分重要。
		而python内建的多线程方法，并不适用于笔者的这种计算密集型算法，而只适用于io密集型算法。因为python为了数据安全等考虑，有一种叫做GIL锁的全局锁，使得无论建立多少线程，一个进程中只能有一条线程同时运行，在计算密集型算法中的效果甚至不如单核直接运行。
		而要突破GIL锁的限制，则需要建立多个进程。多进程不受到GIL锁的管辖，可以同时运行多个重复的程序内容。
		多进程的建立，首先需要建立一个进程池，规定进程池中最多有多少个同时运行的进程。通常这个数字定为设备中CPU的核心数量。
		然后，将之前切片筛选出来的图像通过多进程里内建的方法分别分配给多个进程分别计算，然后在计算之后在返回值中提取出各个切片NMI评价最大值，并得到它们的对应位置，完成4.7的结果评价。
		多进程在笔者的16核cpu上运行，提升了十几倍的运算性能，极大提高了算法实时性。
	4.9 小结
		本章详细描述了实验的整体流程。首先需要对NMI进行代码实现，这也是整个算法的核心，然后对卫星遥感原图像进行预配准工作，之后对图像进行切片和筛选的预处理，接着对筛选后的图像进行位移NMI计算，最后得到评价结果。此外还描述了一种利用多核计算提高算法实时性的多进程算法。相对于上一章的理论描述，这一章重点在实验流程的具体实现和实现的技术细节。至此实验的主体算法部分已经基本完成。
五. 对实验结果的评价
	5.1 概述
		研究需要通过实验结果来推断算法的各项性能，例如通过对图像效果的改善推断算法的有效性，通过对不同目标的判定结果是否一致推断算法的稳定性，通过对比其他方案，观察结果是否相符来推断算法的一致性，还要通过模拟实验拟造“真值”来让算法进行判定是否相符。下面的内容就算根据算法的这几项性能展开探讨。
	5.2 算法的有效性
		算法的最重要性能之一就是有效性。有效性表明这个算法能起到多大效果，能在多大程度上改善配准的效果。但对于亚像元配准工作，受到信息论的约束，即我们不能从像素级别的原图像获得原图像信息以外的更多信息，实际上是不存在配准的“真值”的。所以对于算法的有效性，主要是观察配准前后的多通道合成图像效果对比，通过图像特征目标边缘的拖影大小来判断合成效果。
		对于FY-3D图像，采用通道间配准误差较大的3，4，6通道进行图像合成，而6通道与其他通道的误差尤为明显。
		在本次实验中，通过本算法计算出的结果是6通道与34通道在扫描方向差0.6个像素，所以将图像进行重采样后将34通道图像不动，6通道移动0.6像素，合成第一幅图像，将三幅重采样图像原样合成，形成另一幅图像，将6通道移动1像素，形成第三幅图像。将这三幅图像进行对比，判断算法的有效性。

		[fig.不同位移大小图像对比]

		从上面的图像可以看到，在不位移时，可以看到图像目标边界有明显的拖影，而在位移0.6像素时，图像目标边界拖影基本消失，而在位移1像素时，在目标的另一边边界上出现了明显拖影。这说明根据亚像元配准算法的评价结果来改变图像配准位置确实改善了图像配准效果。
	5.3 算法的稳定性
		一个配准算法几乎不可能对所有目标，所有图像都起到效果，所以需要观察算法的有效应用范围和应用场景。笔者将这个算法应用到了十几幅图像中，并对比了它们的算法准确性，和不同地物目标的配准判定效果。
		由于本次实验的数据来源于一天之内的数据，所以前提假设是光学系统的误差是相对稳定的。所以在这里，采用配准评价结果的众数作为图像间对比的标准。

		[fig.不同目标对应的效果]

		可以看到，图像配准效果随着目标变化而改变，云层越多，特别是细密的云层越多，配准效果就越好越稳定，而海域与配准效果成负相关，海域越多，配准效果越差。而陆地与配准效果的相关关系不是很明显。
		通过不同图像的对比，我们可以看到这个算法在大多数云层比较多的图像中是比较稳定的。
	5.4 算法的一致性
		算法的一致性需要对比其他方案，这里采用的是目前还未发表的程思行(2020)的文章中的方法














[1] 殷德奎.风云三号红外分光计介绍[C].//上海市红外与遥感学会.上海市红外与遥感学会2006年学术年会论文集.2006:1-8.
[2] 杨忠东,张鹏,谷松岩,朱爱军,胡秀清,杨军.FY-3卫星应用和发展[J].上海航天,2017,34(04):1-7.
[3]	遥感图像亚像素插值拟合配准方法, 何斌，禄金波 (1．中国科学院长春光学精密机械与物理研究所，吉林长春130033；2．华为技术有限公司,北京 100081)
[4] Vanewalle P,Suaatrunk S,Wetterli Martin.A frequency domain approach to registration in super resolution[J].Journal on Applied Signal Processing，Special Issue on Super-Resolution，2006:1-14.
[5]	张军本,陶华学.亚像元配准技术研究[J].计算机工程与设计,2009,30(24):5681-5685.
[6]	李新娥,班皓,沙巍, 等.一种大视场TDICCD相机的多传感器图像配准方法[J].液晶与显示,2014,29(4):644-648. DOI:10.3788/YJYXS20142904.0644.
[7]	陈亮,周孟哲,陈禾.一种结合边缘区域和互相关的图像配准方法[J].北京理工大学学报,2016,36(3):320-325. DOI:10.15918/j.tbit1001-0645.2016.03.018.
[8]	别术林.基于互信息的医学图像配准算法研究[D].北京:北京交通大学,2014. DOI:10.7666/d.Y2602492.
[9]	Measurement of the Band-to-Band Registration of the SNPP VIIRS Imaging System From On-Orbit Data James C. Tilton, Senior Member, IEEE, Guoqing Lin, and Bin Tan
[10]倪伟.我国新一代静止轨道气象卫星 风云四号发射成功[J].太空探索,2017,(1):5. DOI:10.3969/j.issn.1009-6205.2017.01.004.
[11]漆成莉,周方,吴春强, 等.风云三号红外高光谱探测仪的光谱定标[J].光学精密工程,2019,27(4):747-755. DOI:10.3788/OPE.20192704.0747.
[12]董瑶海.风云四号气象卫星及其应用展望[J].上海航天,2016,33(2):1-8. DOI:10.19328/j.cnki.1006-1630.2016.02.001.
[13]王淦泉.风云四号气象卫星多通道扫描成像辐射计[C].//中国光学学会%浙江省光学会%浙江大学.2004.
[14]付毅飞. “风云四号”气象卫星正式交付用户[N]. 科技日报,2017-09-26(001).